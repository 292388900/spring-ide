<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="css/style_bean.css" />
<body>
	<script src="http://d3js.org/d3.v3.js"></script>
	<script>
		var width = 960, height = 500, colors = d3.scale.category10();

		var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);

		var force = d3.layout.force().gravity(.3).linkDistance(100).charge(-1500).size([ width, height ]);

		// mouse event vars
		var selected_node = null, selected_link = null, mousedown_link = null, mousedown_node = null, mouseup_node = null;

		function resetMouseVars() {
			mousedown_node = null;
			mouseup_node = null;
			mousedown_link = null;
		}

		function calculateTextWidth(str) {
			var sp = document.createElement("span");
			sp.className = "node_label";
			sp.style.position = "absolute";
			sp.style.top = "-1000px";
			sp.innerHTML = (str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
			document.body.appendChild(sp);
			var w = sp.offsetWidth;
			document.body.removeChild(sp);
			return w + 25;
		}

		// handles to link and node element groups
		var path = svg.append('svg:g').selectAll('line'), circle = svg.append('svg:g').selectAll('g');
		d3.json("graphData.json", function(error, json) {
			force.nodes(json.nodes).links(json.links).start();

			svg.append('svg:defs').append('svg:marker').attr('id', 'end-arrow').attr('viewBox', '0 -5 10 10').attr(
					'refX', 6).attr('markerWidth', 5).attr('markerHeight', 10).attr('orient', 'auto')
					.append('svg:path').attr('d', 'M0,-5L10,0L0,5').attr('fill', '#999');

			svg.append('svg:defs').append('svg:marker').attr('id', 'start-arrow').attr('viewBox', '0 -5 10 10').attr(
					'refX', 4).attr('markerWidth', 5).attr('markerHeight', 10).attr('orient', 'auto')
					.append('svg:path').attr('d', 'M10,-5L0,0L10,5').attr('class', '#999');

			var link = svg.selectAll(".link").data(json.links).enter().append("line").attr("class", "link").classed(
					'selected', function(d) {
						return d === selected_link;
					}).style('marker-start', function(d) {
				return d.left ? 'url(#start-arrow)' : '';
			}).style('marker-end', function(d) {
				return d.right ? 'url(#end-arrow)' : '';
			}).attr('class', 'link').on('mousedown', function(d) {
				if (d3.event.ctrlKey)
					return;

				// select link
				mousedown_link = d;
				if (mousedown_link === selected_link)
					selected_link = null;
				else
					selected_link = mousedown_link;
				selected_node = null;
				restart();
			});

			var node = svg.selectAll(".node").data(json.nodes).enter().append("g").attr("class", "node").call(
					force.drag);

			node.append('circle').attr('class', 'node').attr('r', 5).attr('x', 10).attr('y', -15).classed('reflexive',
					function(d) {
						return d.reflexive;
					}).on("mouseover", function(d) {
				var hover_node = d3.select(this);
				hover_node.classed("node_hovered", true);
			}).on("mouseout", function(d) {
				var hover_node = d3.select(this);
				hover_node.classed("node_hovered", false);
			}).on(
					"dblclick",
					function(d) {
						var bean = json.nodes[d.id];
						ide.call('openBean', bean.beanId + ";" + bean.beanType + ";" + bean.applicationName + ";"
								+ bean.resource)
					});

			node.append("text").attr("dx", 20).attr("dy", 3).attr("class", "node_label").text(function(d) {
				return d.name
			});

			force.on("tick", function() {
				link.attr("d", function(d) {
					return "M" + d.source.x + "," + d.source.y + "S" + d.source.x + "," + d.target.y + " " + d.target.x
							+ "," + d.target.y;
				});
				link.attr("x1", function(d) {
					return d.source.x;
				}).attr("y1", function(d) {
					return d.source.y;
				}).attr("x2", function(d) {
					return d.target.x;
				}).attr("y2", function(d) {
					return d.target.y;
				});

				node.attr("transform", function(d) {
					return "translate(" + d.x + "," + d.y + ")";
				});
			});

		});
	</script>